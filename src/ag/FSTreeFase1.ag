PRAGMA genlinepragmas

imports{
-- libraries
import Graphics.UI.WXCore hiding (empty)
import Graphics.UI.WX hiding (text, empty)

import UU.Pretty
import qualified Data.Map as Map
import System.IO.Unsafe
import Data.List

-- user types and functions
import FSTreeFase2
import CssBox
import PropertyValue
import PropertiesCSS
import DataTreeCSS
import ImageProcess
import AuxiliarFunctions
}

-- datatypes Formatting Structure Fase 1
DATA BoxRoot
    | BoxRoot boxtree: BoxTree

DATA BoxTree
    | BoxContainer
        fcnxt: String
        props: {Map.Map String PropertyValue}
        bRepl: Bool
        attrs: {Map.Map String String}
        boxes: Boxes
    | BoxText 
        props: {Map.Map String PropertyValue}
        attrs: {Map.Map String String}
        text : String

TYPE Boxes = [BoxTree]

-- instances
SET InstancesShow = * - Code
DERIVING InstancesShow: Show

INCLUDE "DoUsedValue.ag"
INCLUDE "BuildLines.ag"

-- Going from Fase 1 to the Fase 2
ATTR BoxRoot BoxTree [|| boxtree: {WindowTree} ]
SEM BoxTree
    | BoxContainer 
        lhs.boxtree 
            = let vdisplay = unKeyComputedValue $ @loc.usedValueProps Map.! "display"
              in case vdisplay of
                    "block"  -> case @fcnxt of
                                    "block"  -> WindowContainer "block"  @loc.usedValueProps @attrs Full @bRepl (EWinds @boxes.boxtrees)
                                    "inline" -> WindowContainer "inline" @loc.usedValueProps @attrs Full @bRepl (ELines @loc.lines)
                    "inline" -> case @fcnxt of
                                    "inline" -> WindowContainer "inline" @loc.usedValueProps @attrs Full @bRepl (EWinds @boxes.boxtrees)
                                    _        -> error $ "[fstree fase 1] unexpected fcontext value: " ++ @fcnxt
                    _        -> error $ "[fstree fase 1] unexpected display value: " ++ vdisplay
    | BoxText
        lhs.boxtree = WindowText @loc.usedValueProps @attrs Full @text

ATTR Boxes [|| boxtrees: {[WindowTree]}]
SEM Boxes
    | Cons lhs.boxtrees = @hd.boxtree : @tl.boxtrees
    | Nil  lhs.boxtrees = []

